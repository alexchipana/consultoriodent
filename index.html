<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultorio Dental - Sistema de Pacientes</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root {
            /* Paleta de colores minimalista y sobria */
            --primary-color: #204362;
            --secondary-color: #16879E;
            --accent-color: #F9A825;
            --danger-color: #D32F2F;
            --light-color: #F5F5F5;
            --dark-color: #263238;
            --text-color: #212121;
            --border-color: #E0E0E0;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.05);
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F9F9F9;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 32px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 500;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color var(--transition-speed);
        }
        
        nav a:hover, nav a.active {
            background-color: rgba(255,255,255,0.2);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .user-role {
            font-size: 12px;
            background-color: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .card-icon.patients {
            background-color: var(--primary-color);
        }
        
        .card-icon.daily {
            background-color: var(--secondary-color);
        }
        
        .card-icon.weekly {
            background-color: var(--accent-color);
        }
        
        .card-icon.today {
            background-color: #7B1FA2;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .card-description {
            color: #757575;
            font-size: 14px;
        }
        
        .form-section {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin: 30px 0;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--dark-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            transition: border-color var(--transition-speed);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1a3450;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #137080;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #d89600;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box {
            min-width: 180px;
            max-width: 220px;
            margin-left: auto;
            display: flex;
            justify-content: flex-end;
        }
        
        .search-input {
            width: 100%;
            max-width: 180px;
            padding: 10px 36px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #757575;
        }
        
        .patient-list {
            margin-top: 20px;
        }
        
        .patient-item {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .patient-item:hover {
            transform: translateX(5px);
        }
        
        .patient-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .patient-info p {
            color: #757575;
            font-size: 14px;
        }
        
        .patient-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 500;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #757575;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .treatment-history {
            margin-top: 30px;
        }
        
        .treatment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .treatment-table th, .treatment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .treatment-table th {
            background-color: var(--light-color);
            font-weight: 500;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-paid {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-pending {
            background-color: #FFF8E1;
            color: #FF8F00;
        }
        
        .status-overdue {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .finance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .finance-item {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .finance-label {
            font-size: 14px;
            color: #757575;
            margin-bottom: 5px;
        }
        
        .finance-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary-color);
            color: white;
            padding: 16px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-speed);
            z-index: 2000;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .patient-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .patient-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .patient-table th, .patient-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .patient-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .patient-table tr:hover {
            background-color: rgba(32, 67, 98, 0.05);
        }
        
        .patient-table .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .patient-table .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .daily-patients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .daily-patients-table th, .daily-patients-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .daily-patients-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .daily-patients-table tr:hover {
            background-color: rgba(32, 67, 98, 0.05);
        }
        
        .revenue-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .revenue-table th, .revenue-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .revenue-table th {
            background-color: var(--light-color);
            font-weight: 500;
        }
        
        .revenue-table tr:hover {
            background-color: rgba(32, 67, 98, 0.05);
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .login-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }
        
        .login-logo {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: var(--dark-color);
            text-align: center;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }
        
        .forgot-password:hover {
            text-decoration: underline;
        }
        
        .login-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 14px;
            color: #757575;
        }
        
        .error-message {
            background-color: #FFEBEE;
            color: var(--danger-color);
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .search-box {
            min-width: 180px;
            max-width: 220px;
            margin-left: auto;
            display: flex;
            justify-content: flex-end;
        }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            z-index: 100;
        }
        
        .fab:hover {
            box-shadow: 0 6px 10px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
        }
        
        .connection-status.connected {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .connection-status.disconnected {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            display: none;
            z-index: 999;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-panel h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--primary-color);
        }
        
        .debug-panel pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .patient-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .patient-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .finance-summary {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .daily-patients-table {
                font-size: 14px;
            }
            
            .daily-patients-table th, .daily-patients-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Application -->
    <div id="mainApp">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="material-icons">healing</i>
                        <h1>Consultorio Dental</h1>
                    </div>
                    <nav>
                        <ul id="mainMenu">
                            <!-- Los elementos del menú se generarán dinámicamente -->
                        </ul>
                    </nav>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div>
                            <div id="userName">Usuario</div>
                            <div class="user-role">Usuario</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section" style="display: none;">
                <div class="dashboard">
                    <div class="card" onclick="showPatientTable()">
                        <div class="card-header">
                            <div class="card-title">Pacientes Atendidos</div>
                            <div class="card-icon patients">
                                <i class="material-icons">group</i>
                            </div>
                        </div>
                        <div class="card-value" id="patientsCount">0</div>
                        <div class="card-description">Total de pacientes registrados</div>
                    </div>
                    
                    <div class="card" onclick="showDailyRevenue()">
                        <div class="card-header">
                            <div class="card-title">Cobros Diarios</div>
                            <div class="card-icon daily">
                                <i class="material-icons">account_balance_wallet</i>
                            </div>
                        </div>
                        <div class="card-value" id="dailyRevenue">Bs. 0</div>
                        <div class="card-description">Ingresos de hoy</div>
                    </div>
                    
                    <div class="card" onclick="showWeeklyRevenue()">
                        <div class="card-header">
                            <div class="card-title">Cobros Semanales</div>
                            <div class="card-icon weekly">
                                <i class="material-icons">date_range</i>
                            </div>
                        </div>
                        <div class="card-value" id="weeklyRevenue">Bs. 0</div>
                        <div class="card-description">Ingresos de esta semana</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pacientes del Día</div>
                            <div class="card-icon today">
                                <i class="material-icons">calendar_today</i>
                            </div>
                        </div>
                        <div class="card-value" id="todayPatients">0</div>
                        <div class="card-description">Pacientes atendidos hoy</div>
                    </div>
                </div>
                
                <!-- Tabla de pacientes por día -->
                <div class="form-section">
                    <h3 class="section-title">Pacientes Registrados por Día</h3>
                    <div class="patient-table-container">
                        <table class="daily-patients-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Número de Pacientes</th>
                                </tr>
                            </thead>
                            <tbody id="dailyPatientsTableBody">
                                <!-- Las filas se generarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Register Patient Section -->
            <section id="register" class="content-section form-section" style="display: none;">
                <h2 class="section-title">Registrar Nuevo Paciente</h2>
                <form id="patientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName">Nombre Completo</label>
                            <input type="text" id="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="idNumber">Carnet de Identidad</label>
                            <input type="text" id="idNumber" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Teléfono</label>
                            <input type="tel" id="phone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="treatmentType">Tipo de Tratamiento</label>
                            <select id="treatmentType" required>
                                <option value="">Seleccione un tratamiento</option>
                                <option value="Limpieza">Limpieza Dental</option>
                                <option value="Extracción">Extracción</option>
                                <option value="Restauración">Restauración</option>
                                <option value="Ortodoncia">Ortodoncia</option>
                                <option value="Blanqueamiento">Blanqueamiento</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="treatmentPrice">Precio del Tratamiento (Bs.)</label>
                            <input type="number" id="treatmentPrice" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="advancePayment">Adelanto (Bs.)</label>
                            <input type="number" id="advancePayment" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="remainingBalance">Saldo Pendiente (Bs.)</label>
                        <input type="number" id="remainingBalance" min="0" step="0.01" readonly>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">save</i>
                        Registrar Paciente
                    </button>
                </form>
            </section>
            
            <!-- Patients Table Section (Main Screen) -->
            <section id="patients" class="content-section form-section">
                <h2 class="section-title">Pacientes Registrados</h2>
                
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showSection('register')">
                            <i class="material-icons">person_add</i>
                            Registrar Paciente
                        </button>
                    </div>
                    <div class="search-box">
                        <div class="search-container">
                            <input type="text" id="searchInput" class="search-input" placeholder="Buscar paciente..." onkeyup="filterPatientsTable()">
                            <i class="material-icons search-icon">search</i>
                        </div>
                    </div>
                </div>
                
                <div class="patient-table-container">
                    <table class="patient-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Completo</th>
                                <th>Carnet de Identidad</th>
                                <th>Teléfono</th>
                                <th>Tratamiento Actual</th>
                                <th>Fecha de Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <!-- Las filas de pacientes se generarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Search Patients Section -->
            <section id="search" class="content-section form-section" style="display: none;">
                <h2 class="section-title">Buscar Pacientes</h2>
                <div class="search-container">
                    <input type="text" id="searchInput2" class="search-input" placeholder="Buscar por nombre, carnet o teléfono...">
                    <i class="material-icons search-icon">search</i>
                </div>
                
                <div id="searchResults" class="patient-list">
                    <!-- Los resultados de búsqueda se mostrarán aquí -->
                </div>
            </section>
        </div>
        
        <!-- Patient Detail Modal -->
        <div id="patientModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Detalles del Paciente</h2>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- El contenido del modal se generará dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Add Treatment Modal -->
        <div id="addTreatmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Agregar Tratamiento</h2>
                    <button class="close-btn" onclick="closeAddTreatmentModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="treatmentForm">
                        <input type="hidden" id="treatmentPatientId">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="treatmentType2">Tipo de Tratamiento</label>
                                <select id="treatmentType2" required>
                                    <option value="">Seleccione un tratamiento</option>
                                    <option value="Limpieza">Limpieza Dental</option>
                                    <option value="Extracción">Extracción</option>
                                    <option value="Restauración">Restauración</option>
                                    <option value="Ortodoncia">Ortodoncia</option>
                                    <option value="Blanqueamiento">Blanqueamiento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="treatmentPrice2">Precio del Tratamiento (Bs.)</label>
                                <input type="number" id="treatmentPrice2" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="advancePayment2">Adelanto (Bs.)</label>
                                <input type="number" id="advancePayment2" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="remainingBalance2">Saldo Pendiente (Bs.)</label>
                            <input type="number" id="remainingBalance2" min="0" step="0.01" readonly>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeAddTreatmentModal()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="material-icons">save</i>
                                Agregar Tratamiento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Revenue Detail Modal -->
        <div id="revenueModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="revenueModalTitle">Detalles de Cobros</h2>
                    <button class="close-btn" onclick="closeRevenueModal()">&times;</button>
                </div>
                <div class="modal-body" id="revenueModalBody">
                    <!-- El contenido del modal se generará dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Notification -->
        <div id="notification" class="notification">
            <i class="material-icons">check_circle</i>
            <span id="notificationText">Operación realizada con éxito</span>
        </div>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status disconnected">
            <i class="material-icons" style="font-size: 14px; margin-right: 4px;">wifi_off</i>
            Sin conexión
        </div>
        
        <!-- Debug Panel -->
        <div id="debugPanel" class="debug-panel">
            <h4>Información de Depuración</h4>
            <pre id="debugInfo"></pre>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://vwnegbxkbddcdqpvuxsu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3bmVnYnhrYmRkY2RxcHZ1eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMTkwNTEsImV4cCI6MjA3MDc5NTA1MX0.pInPqOoOwwzxfscAa-ugXSpavlgJ60BKZi7KxNGy0bs';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Variables globales
        let patients = [];
        let treatments = [];
        let payments = [];
        let currentUser = null;
        let currentPatientId = null;
        let supabaseConnected = false;
        let debugInfo = [];
        
        // El sistema de autenticación ahora es manejado por Supabase
        
        // Función para agregar información de depuración
        function addDebugInfo(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.push(`[${timestamp}] ${message}`);
            console.log(message);
            updateDebugPanel();
        }
        
        // Función para actualizar el panel de depuración
        function updateDebugPanel() {
            const debugPanel = document.getElementById('debugInfo');
            if (debugPanel) {
                debugPanel.textContent = debugInfo.join('\n');
            }
        }
        
        // Función para mostrar/ocultar el panel de depuración
        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('show');
        }
        
        // Función para actualizar el estado de conexión
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '<i class="material-icons" style="font-size: 14px; margin-right: 4px;">wifi</i>Conectado';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '<i class="material-icons" style="font-size: 14px; margin-right: 4px;">wifi_off</i>Sin conexión';
            }
        }
        
        // Función para probar la conexión a Supabase
        async function testSupabaseConnection() {
            try {
                addDebugInfo('Probando conexión a Supabase...');
                addDebugInfo(`URL: ${SUPABASE_URL}`);
                addDebugInfo(`Key: ${SUPABASE_KEY ? 'Presente' : 'Ausente'}`);
                
                // Intentar una consulta simple
                const { data, error } = await supabase.from('patients').select('count', { count: 'exact', head: true });

                if (error) {
                    addDebugInfo(`Error de conexión a Supabase: ${error.message}`);
                    addDebugInfo(`Código de error: ${error.code}`);
                    addDebugInfo(`Detalles: ${error.details || 'No disponibles'}`);
                    return false;
                }

                // Si data es null, la tabla está vacía o no existe
                if (!data) {
                    addDebugInfo('Conexión exitosa, pero la tabla "patients" está vacía o no existe.');
                    return true;
                }

                // Si data.count es undefined, mostrar 0
                addDebugInfo(`Conexión exitosa a Supabase. Pacientes encontrados: ${typeof data.count !== 'undefined' ? data.count : 0}`);
                return true;
            } catch (err) {
                addDebugInfo(`Error al probar conexión: ${err.message}`);
                addDebugInfo(`Nombre del error: ${err.name}`);
                return false;
            }
        }
        
        // Función para guardar sesión en localStorage
        function saveSession(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }
        
        // Función para cargar sesión desde localStorage
        function loadSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                return JSON.parse(savedUser);
            }
            return null;
        }
        
        // Función para obtener pacientes desde Supabase
        async function getPatientsFromAPI() {
            try {
                addDebugInfo('Obteniendo pacientes desde Supabase...');
                const { data, error } = await supabase
                    .from('patients')
                    .select('*');
                
                if (error) {
                    addDebugInfo(`Error al obtener pacientes: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pacientes obtenidos: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al obtener pacientes: ${error.message}`);
                throw error;
            }
        }
        
        // Función para agregar un paciente usando Supabase
        async function addPatientToAPI(patientData) {
            try {
                addDebugInfo('Agregando paciente a Supabase...');
                const { data, error } = await supabase
                    .from('patients')
                    .insert([patientData])
                    .select();
                
                if (error) {
                    addDebugInfo(`Error al agregar paciente: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Paciente agregado con ID: ${data[0].id}`);
                return data[0].id;
            } catch (error) {
                addDebugInfo(`Error al agregar paciente: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener tratamientos desde Supabase
        async function getTreatmentsFromAPI() {
            try {
                addDebugInfo('Obteniendo tratamientos desde Supabase...');
                const { data, error } = await supabase
                    .from('treatments')
                    .select('*');
                
                if (error) {
                    addDebugInfo(`Error al obtener tratamientos: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Tratamientos obtenidos: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al obtener tratamientos: ${error.message}`);
                throw error;
            }
        }
        
        // Función para agregar un tratamiento usando Supabase
        async function addTreatmentToAPI(treatmentData) {
            try {
                addDebugInfo('Agregando tratamiento a Supabase...');
                const { data, error } = await supabase
                    .from('treatments')
                    .insert([treatmentData])
                    .select();
                
                if (error) {
                    addDebugInfo(`Error al agregar tratamiento: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Tratamiento agregado con ID: ${data[0].id}`);
                return data[0].id;
            } catch (error) {
                addDebugInfo(`Error al agregar tratamiento: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener pagos desde Supabase
        async function getPaymentsFromAPI() {
            try {
                addDebugInfo('Obteniendo pagos desde Supabase...');
                const { data, error } = await supabase
                    .from('payments')
                    .select('*');
                
                if (error) {
                    addDebugInfo(`Error al obtener pagos: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pagos obtenidos: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al obtener pagos: ${error.message}`);
                throw error;
            }
        }
        
        // Función para agregar un pago usando Supabase
        async function addPaymentToAPI(paymentData) {
            try {
                addDebugInfo('Agregando pago a Supabase...');
                const { data, error } = await supabase
                    .from('payments')
                    .insert([paymentData])
                    .select();
                
                if (error) {
                    addDebugInfo(`Error al agregar pago: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pago agregado con ID: ${data[0].id}`);
                return data[0].id;
            } catch (error) {
                addDebugInfo(`Error al agregar pago: ${error.message}`);
                throw error;
            }
        }
        
        // Función para buscar pacientes usando Supabase
        async function searchPatientsOnAPI(query) {
            try {
                addDebugInfo(`Buscando pacientes con query: ${query}`);
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .or(`full_name.ilike.%${query}%,id_number.ilike.%${query}%,phone.ilike.%${query}%`);
                
                if (error) {
                    addDebugInfo(`Error al buscar pacientes: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pacientes encontrados: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al buscar pacientes: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener detalles de un paciente usando Supabase
        async function getPatientDetailsFromAPI(patientId) {
            try {
                addDebugInfo(`Obteniendo detalles del paciente ID: ${patientId}`);
                
                // Obtener paciente
                const { data: patient, error: patientError } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('id', patientId)
                    .single();
                
                if (patientError) throw patientError;
                
                // Obtener tratamientos del paciente
                const { data: treatments, error: treatmentsError } = await supabase
                    .from('treatments')
                    .select('*')
                    .eq('patient_id', patientId);
                
                if (treatmentsError) throw treatmentsError;
                
                // Obtener IDs de tratamientos
                const treatmentIds = (treatments || []).map(t => t.id);
                
                // Obtener pagos de los tratamientos
                let payments = [];
                if (treatmentIds.length > 0) {
                    const { data: paymentsData, error: paymentsError } = await supabase
                        .from('payments')
                        .select('*')
                        .in('treatment_id', treatmentIds);
                    
                    if (paymentsError) throw paymentsError;
                    payments = paymentsData || [];
                }
                
                addDebugInfo('Detalles del paciente obtenidos');
                return {
                    patient,
                    treatments: treatments || [],
                    payments
                };
            } catch (error) {
                addDebugInfo(`Error al obtener detalles del paciente: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener estadísticas usando Supabase
        async function getStatisticsFromAPI() {
            try {
                addDebugInfo('Obteniendo estadísticas desde Supabase...');
                
                // Obtener conteo de pacientes
                const { count: patientsCount, error: patientsError } = await supabase
                    .from('patients')
                    .select('*', { count: 'exact', head: true });
                
                if (patientsError) throw patientsError;
                
                // Obtener pagos de hoy
                const today = new Date().toISOString().split('T')[0];
                const { data: todayPayments, error: todayPaymentsError } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('date', today);
                
                if (todayPaymentsError) throw todayPaymentsError;
                
                const dailyRevenue = (todayPayments || []).reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
                
                // Obtener pagos de la última semana
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const { data: weekPayments, error: weekPaymentsError } = await supabase
                    .from('payments')
                    .select('*')
                    .gte('date', oneWeekAgo.toISOString().split('T')[0]);
                
                if (weekPaymentsError) throw weekPaymentsError;
                
                const weeklyRevenue = (weekPayments || []).reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
                
                // Obtener tratamientos de hoy
                const { data: todayTreatments, error: todayTreatmentsError } = await supabase
                    .from('treatments')
                    .select('patient_id')
                    .eq('date', today);
                
                if (todayTreatmentsError) throw todayTreatmentsError;
                
                const todayPatientIds = [...new Set((todayTreatments || []).map(t => t.patient_id))];
                const todayPatientsCount = todayPatientIds.length;
                
                // Obtener pacientes por día (últimos 7 días)
                const dailyPatients = {};
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const { count, error } = await supabase
                        .from('patients')
                        .select('*', { count: 'exact', head: true })
                        .eq('registration_date', dateStr);
                    
                    if (error) throw error;
                    dailyPatients[dateStr] = count || 0;
                }
                
                addDebugInfo('Estadísticas obtenidas');
                return {
                    patientsCount: patientsCount || 0,
                    dailyRevenue,
                    weeklyRevenue,
                    todayPatientsCount,
                    dailyPatients
                };
            } catch (error) {
                addDebugInfo(`Error al obtener estadísticas: ${error.message}`);
                throw error;
            }
        }
        
        // Cargar datos desde la API
        async function loadDataFromAPI() {
            try {
                addDebugInfo('Iniciando carga de datos desde Supabase...');
                
                // Probar conexión primero
                supabaseConnected = await testSupabaseConnection();
                updateConnectionStatus(supabaseConnected);
                
                if (!supabaseConnected) {
                    throw new Error('No se pudo conectar a Supabase');
                }
                
                // Cargar pacientes
                patients = await getPatientsFromAPI();
                
                // Cargar tratamientos
                treatments = await getTreatmentsFromAPI();
                
                // Cargar pagos
                payments = await getPaymentsFromAPI();
                
                addDebugInfo('Datos cargados exitosamente desde Supabase');
                return true;
            } catch (error) {
                addDebugInfo(`Error al cargar datos desde la API: ${error.message}`);
                showNotification('Error al cargar los datos desde Supabase. Verifique la conexión.', 'error');
                patients = [];
                treatments = [];
                payments = [];
                return false;
            }
        }
        
        // Elimina toda lógica de login y autenticación
        // Inicialización directa

        document.addEventListener('DOMContentLoaded', function() {
            addDebugInfo('DOM cargado, inicializando aplicación...');
            document.getElementById('mainApp').style.display = 'block';
            currentUser = { name: 'Usuario', avatar: 'U', email: '' };
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('userName').textContent = currentUser.name;
            generateMenu();
            document.getElementById('patientForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('treatmentForm').addEventListener('submit', handleTreatmentSubmit);
            document.getElementById('searchInput2').addEventListener('input', handleSearch);
            document.getElementById('treatmentPrice').addEventListener('input', calculateBalance);
            document.getElementById('advancePayment').addEventListener('input', calculateBalance);
            document.getElementById('treatmentPrice2').addEventListener('input', calculateBalance2);
            document.getElementById('advancePayment2').addEventListener('input', calculateBalance2);
            loadDataFromAPI().then(() => {
                showSection('patients');
                updateDashboard();
            });
        });
    </script>
</body>
</html>
