<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultorio Dental - Sistema de Pacientes</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root {
            /* Paleta de colores minimalista y sobria */
            --primary-color: #204362;
            --secondary-color: #16879E;
            --accent-color: #F9A825;
            --danger-color: #D32F2F;
            --light-color: #F5F5F5;
            --dark-color: #263238;
            --text-color: #212121;
            --border-color: #E0E0E0;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.05);
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F9F9F9;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 32px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 500;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color var(--transition-speed);
        }
        
        nav a:hover, nav a.active {
            background-color: rgba(255,255,255,0.2);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .user-role {
            font-size: 12px;
            background-color: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .card-icon.patients {
            background-color: var(--primary-color);
        }
        
        .card-icon.daily {
            background-color: var(--secondary-color);
        }
        
        .card-icon.weekly {
            background-color: var(--accent-color);
        }
        
        .card-icon.today {
            background-color: #7B1FA2;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .card-description {
            color: #757575;
            font-size: 14px;
        }
        
        .form-section {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin: 30px 0;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--dark-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            transition: border-color var(--transition-speed);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1a3450;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #137080;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #d89600;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box {
            min-width: 180px;
            max-width: 220px;
            margin-left: auto;
            display: flex;
            justify-content: flex-end;
        }
        
        .search-input {
            width: 100%;
            max-width: 180px;
            padding: 10px 36px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #757575;
        }
        
        .patient-list {
            margin-top: 20px;
        }
        
        .patient-item {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .patient-item:hover {
            transform: translateX(5px);
        }
        
        .patient-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .patient-info p {
            color: #757575;
            font-size: 14px;
        }
        
        .patient-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 500;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #757575;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .treatment-history {
            margin-top: 30px;
        }
        
        .treatment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .treatment-table th, .treatment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .treatment-table th {
            background-color: var(--light-color);
            font-weight: 500;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-paid {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-pending {
            background-color: #FFF8E1;
            color: #FF8F00;
        }
        
        .status-overdue {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .finance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .finance-item {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .finance-label {
            font-size: 14px;
            color: #757575;
            margin-bottom: 5px;
        }
        
        .finance-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary-color);
            color: white;
            padding: 16px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-speed);
            z-index: 2000;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .patient-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .patient-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .patient-table th, .patient-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .patient-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .patient-table tr:hover {
            background-color: rgba(32, 67, 98, 0.05);
        }
        
        .patient-table .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .patient-table .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .daily-patients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .daily-patients-table th, .daily-patients-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .daily-patients-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .daily-patients-table tr:hover {
            background-color: rgba(32, 67, 98, 0.05);
        }
        
        .revenue-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .revenue-table th, .revenue-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .revenue-table th {
            background-color: var(--light-color);
            font-weight: 500;
        }
        
        .revenue-table tr:hover {
            background-color: rgba(32, 67, 98, 0.05);
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .login-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }
        
        .login-logo {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: var(--dark-color);
            text-align: center;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }
        
        .forgot-password:hover {
            text-decoration: underline;
        }
        
        .login-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 14px;
            color: #757575;
        }
        
        .error-message {
            background-color: #FFEBEE;
            color: var(--danger-color);
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .search-box {
            min-width: 180px;
            max-width: 220px;
            margin-left: auto;
            display: flex;
            justify-content: flex-end;
        }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            z-index: 100;
        }
        
        .fab:hover {
            box-shadow: 0 6px 10px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
        }
        
        .connection-status.connected {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .connection-status.disconnected {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            display: none;
            z-index: 999;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-panel h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--primary-color);
        }
        
        .debug-panel pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .patient-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .patient-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .finance-summary {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .daily-patients-table {
                font-size: 14px;
            }
            
            .daily-patients-table th, .daily-patients-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <i class="material-icons login-logo">healing</i>
            <h2 class="login-title">Consultorio Dental</h2>
            <p>Inicie sesión para acceder al sistema</p>
            
            <div class="error-message" id="loginError">
                Usuario o contraseña incorrectos. Intente nuevamente.
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Email</label>
                        <input type="text" id="username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" required>
                </div>
                
                <div class="login-options">
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Recordarme</label>
                    </div>
                    <a href="#" class="forgot-password">¿Olvidó su contraseña?</a>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="material-icons">login</i>
                    Iniciar Sesión
                </button>
            </form>
            
            <div class="login-footer">
                <p>© 2025 Consultorio Dental</p>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden initially) -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="material-icons">healing</i>
                        <h1>Consultorio Dental</h1>
                    </div>
                    <nav>
                        <ul id="mainMenu">
                            <!-- Los elementos del menú se generarán dinámicamente -->
                        </ul>
                    </nav>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div>
                            <div id="userName">Usuario</div>
                            <div class="user-role">Usuario</div>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="logout()">
                            <i class="material-icons">logout</i>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section" style="display: none;">
                <div class="dashboard">
                    <div class="card" onclick="showPatientTable()">
                        <div class="card-header">
                            <div class="card-title">Pacientes Atendidos</div>
                            <div class="card-icon patients">
                                <i class="material-icons">group</i>
                            </div>
                        </div>
                        <div class="card-value" id="patientsCount">0</div>
                        <div class="card-description">Total de pacientes registrados</div>
                    </div>
                    
                    <div class="card" onclick="showDailyRevenue()">
                        <div class="card-header">
                            <div class="card-title">Cobros Diarios</div>
                            <div class="card-icon daily">
                                <i class="material-icons">account_balance_wallet</i>
                            </div>
                        </div>
                        <div class="card-value" id="dailyRevenue">Bs. 0</div>
                        <div class="card-description">Ingresos de hoy</div>
                    </div>
                    
                    <div class="card" onclick="showWeeklyRevenue()">
                        <div class="card-header">
                            <div class="card-title">Cobros Semanales</div>
                            <div class="card-icon weekly">
                                <i class="material-icons">date_range</i>
                            </div>
                        </div>
                        <div class="card-value" id="weeklyRevenue">Bs. 0</div>
                        <div class="card-description">Ingresos de esta semana</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pacientes del Día</div>
                            <div class="card-icon today">
                                <i class="material-icons">calendar_today</i>
                            </div>
                        </div>
                        <div class="card-value" id="todayPatients">0</div>
                        <div class="card-description">Pacientes atendidos hoy</div>
                    </div>
                </div>
                
                <!-- Tabla de pacientes por día -->
                <div class="form-section">
                    <h3 class="section-title">Pacientes Registrados por Día</h3>
                    <div class="patient-table-container">
                        <table class="daily-patients-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Número de Pacientes</th>
                                </tr>
                            </thead>
                            <tbody id="dailyPatientsTableBody">
                                <!-- Las filas se generarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Register Patient Section -->
            <section id="register" class="content-section form-section" style="display: none;">
                <h2 class="section-title">Registrar Nuevo Paciente</h2>
                <form id="patientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName">Nombre Completo</label>
                            <input type="text" id="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="idNumber">Carnet de Identidad</label>
                            <input type="text" id="idNumber" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Teléfono</label>
                            <input type="tel" id="phone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="treatmentType">Tipo de Tratamiento</label>
                            <select id="treatmentType" required>
                                <option value="">Seleccione un tratamiento</option>
                                <option value="Limpieza">Limpieza Dental</option>
                                <option value="Extracción">Extracción</option>
                                <option value="Restauración">Restauración</option>
                                <option value="Ortodoncia">Ortodoncia</option>
                                <option value="Blanqueamiento">Blanqueamiento</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="treatmentPrice">Precio del Tratamiento (Bs.)</label>
                            <input type="number" id="treatmentPrice" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="advancePayment">Adelanto (Bs.)</label>
                            <input type="number" id="advancePayment" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="remainingBalance">Saldo Pendiente (Bs.)</label>
                        <input type="number" id="remainingBalance" min="0" step="0.01" readonly>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">save</i>
                        Registrar Paciente
                    </button>
                </form>
            </section>
            
            <!-- Patients Table Section (Main Screen) -->
            <section id="patients" class="content-section form-section">
                <h2 class="section-title">Pacientes Registrados</h2>
                
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showSection('register')">
                            <i class="material-icons">person_add</i>
                            Registrar Paciente
                        </button>
                        <button class="btn btn-accent" onclick="reloadData()" title="Recargar datos">
                            <i class="material-icons">refresh</i>
                        </button>
                    </div>
                    <div class="search-box">
                        <div class="search-container">
                            <input type="text" id="searchInput" class="search-input" placeholder="Buscar paciente..." onkeyup="filterPatientsTable()">
                            <i class="material-icons search-icon">search</i>
                        </div>
                    </div>
                </div>
                
                <div class="patient-table-container">
                    <table class="patient-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Completo</th>
                                <th>Carnet de Identidad</th>
                                <th>Teléfono</th>
                                <th>Tratamiento Actual</th>
                                <th>Fecha de Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <!-- Las filas de pacientes se generarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Search Patients Section -->
            <section id="search" class="content-section form-section" style="display: none;">
                <h2 class="section-title">Buscar Pacientes</h2>
                <div class="search-container">
                    <input type="text" id="searchInput2" class="search-input" placeholder="Buscar por nombre, carnet o teléfono...">
                    <i class="material-icons search-icon">search</i>
                </div>
                
                <div id="searchResults" class="patient-list">
                    <!-- Los resultados de búsqueda se mostrarán aquí -->
                </div>
            </section>
        </div>
        
        <!-- Patient Detail Modal -->
        <div id="patientModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Detalles del Paciente</h2>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- El contenido del modal se generará dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Add Treatment Modal -->
        <div id="addTreatmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Agregar Tratamiento</h2>
                    <button class="close-btn" onclick="closeAddTreatmentModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="treatmentForm">
                        <input type="hidden" id="treatmentPatientId">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="treatmentType2">Tipo de Tratamiento</label>
                                <select id="treatmentType2" required>
                                    <option value="">Seleccione un tratamiento</option>
                                    <option value="Limpieza">Limpieza Dental</option>
                                    <option value="Extracción">Extracción</option>
                                    <option value="Restauración">Restauración</option>
                                    <option value="Ortodoncia">Ortodoncia</option>
                                    <option value="Blanqueamiento">Blanqueamiento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="treatmentPrice2">Precio del Tratamiento (Bs.)</label>
                                <input type="number" id="treatmentPrice2" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="advancePayment2">Adelanto (Bs.)</label>
                                <input type="number" id="advancePayment2" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="remainingBalance2">Saldo Pendiente (Bs.)</label>
                            <input type="number" id="remainingBalance2" min="0" step="0.01" readonly>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeAddTreatmentModal()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="material-icons">save</i>
                                Agregar Tratamiento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Revenue Detail Modal -->
        <div id="revenueModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="revenueModalTitle">Detalles de Cobros</h2>
                    <button class="close-btn" onclick="closeRevenueModal()">&times;</button>
                </div>
                <div class="modal-body" id="revenueModalBody">
                    <!-- El contenido del modal se generará dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Notification -->
        <div id="notification" class="notification">
            <i class="material-icons">check_circle</i>
            <span id="notificationText">Operación realizada con éxito</span>
        </div>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status disconnected">
            <i class="material-icons" style="font-size: 14px; margin-right: 4px;">wifi_off</i>
            Sin conexión
        </div>
        
        <!-- Debug Panel -->
        <div id="debugPanel" class="debug-panel">
            <h4>Información de Depuración</h4>
            <pre id="debugInfo"></pre>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://vwnegbxkbddcdqpvuxsu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3bmVnYnhrYmRkY2RxcHZ1eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMTkwNTEsImV4cCI6MjA3MDc5NTA1MX0.pInPqOoOwwzxfscAa-ugXSpavlgJ60BKZi7KxNGy0bs';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Variables globales
        let patients = [];
        let treatments = [];
        let payments = [];
        let currentUser = null;
        let currentPatientId = null;
        let supabaseConnected = false;
        let debugInfo = [];
        
        // El sistema de autenticación ahora es manejado por Supabase
        
        // Función para agregar información de depuración
        function addDebugInfo(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.push(`[${timestamp}] ${message}`);
            console.log(message);
            updateDebugPanel();
        }
        
        // Función para actualizar el panel de depuración
        function updateDebugPanel() {
            const debugPanel = document.getElementById('debugInfo');
            if (debugPanel) {
                debugPanel.textContent = debugInfo.join('\n');
            }
        }
        
        // Función para mostrar/ocultar el panel de depuración
        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('show');
        }
        
        // Función para actualizar el estado de conexión
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '<i class="material-icons" style="font-size: 14px; margin-right: 4px;">wifi</i>Conectado';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '<i class="material-icons" style="font-size: 14px; margin-right: 4px;">wifi_off</i>Sin conexión';
            }
        }
        
        // Función para probar la conexión a Supabase
        async function testSupabaseConnection() {
            try {
                addDebugInfo('Probando conexión a Supabase...');
                addDebugInfo(`URL: ${SUPABASE_URL}`);
                addDebugInfo(`Key: ${SUPABASE_KEY ? 'Presente' : 'Ausente'}`);
                
                // Intentar una consulta simple
                const { data, error } = await supabase.from('patients').select('count', { count: 'exact', head: true });

                if (error) {
                    addDebugInfo(`Error de conexión a Supabase: ${error.message}`);
                    addDebugInfo(`Código de error: ${error.code}`);
                    addDebugInfo(`Detalles: ${error.details || 'No disponibles'}`);
                    return false;
                }

                // Si data es null, la tabla está vacía o no existe
                if (!data) {
                    addDebugInfo('Conexión exitosa, pero la tabla "patients" está vacía o no existe.');
                    return true;
                }

                // Si data.count es undefined, mostrar 0
                addDebugInfo(`Conexión exitosa a Supabase. Pacientes encontrados: ${typeof data.count !== 'undefined' ? data.count : 0}`);
                return true;
            } catch (err) {
                addDebugInfo(`Error al probar conexión: ${err.message}`);
                addDebugInfo(`Nombre del error: ${err.name}`);
                return false;
            }
        }
        
        // Función para guardar sesión en localStorage
        function saveSession(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }
        
        // Función para cargar sesión desde localStorage
        function loadSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                return JSON.parse(savedUser);
            }
            return null;
        }
        
        // Función para obtener pacientes desde Supabase
        async function getPatientsFromAPI() {
            try {
                addDebugInfo('Obteniendo pacientes desde Supabase...');
                const { data, error } = await supabase
                    .from('patients')
                    .select('*');
                
                if (error) {
                    addDebugInfo(`Error al obtener pacientes: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pacientes obtenidos: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al obtener pacientes: ${error.message}`);
                throw error;
            }
        }
        
        // Función para agregar un paciente usando Supabase
        async function addPatientToAPI(patientData) {
            try {
                addDebugInfo('Agregando paciente a Supabase...');
                const { data, error } = await supabase
                    .from('patients')
                    .insert([patientData])
                    .select();
                
                if (error) {
                    addDebugInfo(`Error al agregar paciente: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Paciente agregado con ID: ${data[0].id}`);
                return data[0].id;
            } catch (error) {
                addDebugInfo(`Error al agregar paciente: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener tratamientos desde Supabase
        async function getTreatmentsFromAPI() {
            try {
                addDebugInfo('Obteniendo tratamientos desde Supabase...');
                const { data, error } = await supabase
                    .from('treatments')
                    .select('*');
                
                if (error) {
                    addDebugInfo(`Error al obtener tratamientos: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Tratamientos obtenidos: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al obtener tratamientos: ${error.message}`);
                throw error;
            }
        }
        
        // Función para agregar un tratamiento usando Supabase
        async function addTreatmentToAPI(treatmentData) {
            try {
                addDebugInfo('Agregando tratamiento a Supabase...');
                const { data, error } = await supabase
                    .from('treatments')
                    .insert([treatmentData])
                    .select();
                
                if (error) {
                    addDebugInfo(`Error al agregar tratamiento: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Tratamiento agregado con ID: ${data[0].id}`);
                return data[0].id;
            } catch (error) {
                addDebugInfo(`Error al agregar tratamiento: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener pagos desde Supabase
        async function getPaymentsFromAPI() {
            try {
                addDebugInfo('Obteniendo pagos desde Supabase...');
                const { data, error } = await supabase
                    .from('payments')
                    .select('*');
                
                if (error) {
                    addDebugInfo(`Error al obtener pagos: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pagos obtenidos: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al obtener pagos: ${error.message}`);
                throw error;
            }
        }
        
        // Función para agregar un pago usando Supabase
        async function addPaymentToAPI(paymentData) {
            try {
                addDebugInfo('Agregando pago a Supabase...');
                const { data, error } = await supabase
                    .from('payments')
                    .insert([paymentData])
                    .select();
                
                if (error) {
                    addDebugInfo(`Error al agregar pago: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pago agregado con ID: ${data[0].id}`);
                return data[0].id;
            } catch (error) {
                addDebugInfo(`Error al agregar pago: ${error.message}`);
                throw error;
            }
        }
        
        // Función para buscar pacientes usando Supabase
        async function searchPatientsOnAPI(query) {
            try {
                addDebugInfo(`Buscando pacientes con query: ${query}`);
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .or(`full_name.ilike.%${query}%,id_number.ilike.%${query}%,phone.ilike.%${query}%`);
                
                if (error) {
                    addDebugInfo(`Error al buscar pacientes: ${error.message}`);
                    throw error;
                }
                
                addDebugInfo(`Pacientes encontrados: ${data ? data.length : 0}`);
                return data || [];
            } catch (error) {
                addDebugInfo(`Error al buscar pacientes: ${error.message}`);
                throw error;
            }
        }
        
        // Función para obtener detalles de un paciente usando Supabase
        async function getPatientDetailsFromAPI(patientId) {
            try {
                addDebugInfo(`Obteniendo detalles del paciente ID: ${patientId}`);
                
                // Obtener paciente
                const { data: patient, error: patientError } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('id', patientId)
                    .single();
                
                if (patientError) throw patientError;
                
                // Obtener tratamientos del paciente
                const { data: treatments, error: treatmentsError } = await supabase
                    .from('treatments')
                    .select('*')
                    .eq('patient_id', patientId);
                
                if (treatmentsError) throw treatmentsError;
                
                // Obtener IDs de tratamientos
                const treatmentIds = (treatments || []).map(t => t.id);
                
                // Obtener pagos de los tratamientos
                let payments = [];
                if (treatmentIds.length > 0) {
                    const { data: paymentsData, error: paymentsError } = await supabase
                        .from('payments')
                        .select('*')
                        .in('treatment_id', treatmentIds);
                    
                    if (paymentsError) throw paymentsError;
            // Mostrar la pantalla principal automáticamente
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            // Usuario genérico
            var user = {
                email: 'demo',
                name: 'Demo',
                role: 'demo',
                avatar: 'D'
            };
            saveSession(user);
            currentUser = user;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('userName').textContent = currentUser.name;
            document.querySelector('.user-role').textContent = currentUser.role;
            generateMenu();
            loadDataFromAPI().then(function() {
                showSection('patients');
                updateDashboard();
            });
                    .select('patient_id')
                    .eq('date', today);
                
                if (todayTreatmentsError) throw todayTreatmentsError;
                
                const todayPatientIds = [...new Set((todayTreatments || []).map(t => t.patient_id))];
                const todayPatientsCount = todayPatientIds.length;
                
                // Obtener pacientes por día (últimos 7 días)
                const dailyPatients = {};
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const { count, error } = await supabase
                        .from('patients')
                        .select('*', { count: 'exact', head: true })
                        .eq('registration_date', dateStr);
                    
                    if (error) throw error;
                    dailyPatients[dateStr] = count || 0;
                }
                
                addDebugInfo('Estadísticas obtenidas');
                return {
                    patientsCount: patientsCount || 0,
                    dailyRevenue,
                    weeklyRevenue,
                    todayPatientsCount,
                    dailyPatients
                };
            } catch (error) {
                addDebugInfo(`Error al obtener estadísticas: ${error.message}`);
                throw error;
            }
        }
        
        // Cargar datos desde la API
        async function loadDataFromAPI() {
            try {
                addDebugInfo('Iniciando carga de datos desde Supabase...');
                
                // Probar conexión primero
                supabaseConnected = await testSupabaseConnection();
                updateConnectionStatus(supabaseConnected);
                
                if (!supabaseConnected) {
                    throw new Error('No se pudo conectar a Supabase');
                }
                
                // Cargar pacientes
                patients = await getPatientsFromAPI();
                
                // Cargar tratamientos
                treatments = await getTreatmentsFromAPI();
                
                // Cargar pagos
                payments = await getPaymentsFromAPI();
                
                addDebugInfo('Datos cargados exitosamente desde Supabase');
                return true;
            } catch (error) {
                addDebugInfo(`Error al cargar datos desde la API: ${error.message}`);
                showNotification('Error al cargar los datos desde Supabase. Verifique la conexión.', 'error');
                patients = [];
                treatments = [];
                payments = [];
                return false;
            }
        }
        
        // Manejar inicio de sesión
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            if (!username || !password) {
                loginError.textContent = 'Debe ingresar usuario y contraseña.';
                loginError.style.display = 'block';
                setTimeout(() => { loginError.style.display = 'none'; }, 3000);
                return;
            }

            try {
                const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('username', username)
                        .eq('password', password)
                        .single();
                if (error || !data) {
                    loginError.textContent = 'Usuario o contraseña incorrectos.';
                    loginError.style.display = 'block';
                    setTimeout(() => { loginError.style.display = 'none'; }, 3000);
                    return;
                }
                // Usuario autenticado correctamente
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                const user = {
                    e.preventDefault();
                    // Mostrar directamente la página principal y cargar datos
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    // Usuario genérico
                    var user = {
                        email: 'demo',
                        name: 'Demo',
                        role: 'demo',
                        avatar: 'D'
                    };
                    saveSession(user);
                    currentUser = user;
                    document.getElementById('userAvatar').textContent = currentUser.avatar;
                    document.getElementById('userName').textContent = currentUser.name;
                    document.querySelector('.user-role').textContent = currentUser.role;
                    generateMenu();
                    loadDataFromAPI().then(function() {
                        showSection('patients');
                        updateDashboard();
                    });
        
        // Mostrar sección
        function showSection(sectionId) {
            addDebugInfo(`Mostrando sección: ${sectionId}`);
            
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar la sección seleccionada
            document.getElementById(sectionId).style.display = 'block';
            
            // Actualizar menú activo
            document.querySelectorAll('#mainMenu a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`#mainMenu a[onclick="showSection('${sectionId}')"]`)?.classList.add('active');
            
            // Actualizar contenido específico de cada sección
            if (sectionId === 'patients') {
                populatePatientsTable();
            } else if (sectionId === 'dashboard') {
                updateDashboard();
                populateDailyPatientsTable();
            }
        }
        
        // Manejar envío del formulario
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                // Obtener datos del formulario
                const fullName = document.getElementById('fullName').value;
                const idNumber = document.getElementById('idNumber').value;
                const phone = document.getElementById('phone').value;
                const treatmentType = document.getElementById('treatmentType').value;
                const treatmentPrice = parseFloat(document.getElementById('treatmentPrice').value);
                const advancePayment = parseFloat(document.getElementById('advancePayment').value);
                const remainingBalance = parseFloat(document.getElementById('remainingBalance').value);
                
                addDebugInfo(`Registrando nuevo paciente: ${fullName}`);
                
                // Crear nuevo paciente
                const newPatient = {
                    full_name: fullName,
                    id_number: idNumber,
                    phone: phone,
                    registered_by: "user",
                    registration_date: new Date().toISOString().split('T')[0]
                };
                
                // Agregar paciente a Supabase
                const patientId = await addPatientToAPI(newPatient);
                
                // Crear nuevo tratamiento
                const newTreatment = {
                    patient_id: patientId,
                    type: treatmentType,
                    price: treatmentPrice,
                    date: new Date().toISOString().split('T')[0]
                };
                
                // Agregar tratamiento a Supabase
                const treatmentId = await addTreatmentToAPI(newTreatment);
                
                // Crear nuevo pago
                const newPayment = {
                    treatment_id: treatmentId,
                    amount: advancePayment,
                    date: new Date().toISOString().split('T')[0],
                    status: remainingBalance > 0 ? "pending" : "paid"
                };
                
                // Agregar pago a Supabase
                await addPaymentToAPI(newPayment);
                
                // Recargar datos desde la API
                await loadDataFromAPI();
                
                // Reiniciar formulario
                document.getElementById('patientForm').reset();
                
                // Mostrar notificación
                showNotification('Paciente registrado con éxito');
                
                // Actualizar dashboard
                updateDashboard();
                
                // Volver a la tabla de pacientes
                showSection('patients');
            } catch (error) {
                addDebugInfo(`Error al registrar paciente: ${error.message}`);
                showNotification('Error al registrar el paciente', 'error');
            }
        }
        
        // Calcular saldo pendiente
        function calculateBalance() {
            const price = parseFloat(document.getElementById('treatmentPrice').value) || 0;
            const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
            const balance = price - advance;
            
            document.getElementById('remainingBalance').value = balance.toFixed(2);
        }
        
        // Calcular saldo pendiente para el modal de tratamiento
        function calculateBalance2() {
            const price = parseFloat(document.getElementById('treatmentPrice2').value) || 0;
            const advance = parseFloat(document.getElementById('advancePayment2').value) || 0;
            const balance = price - advance;
            
            document.getElementById('remainingBalance2').value = balance.toFixed(2);
        }
        
        // Manejar envío del formulario de tratamiento
        async function handleTreatmentSubmit(e) {
            e.preventDefault();
            
            try {
                // Obtener datos del formulario
                const patientId = parseInt(document.getElementById('treatmentPatientId').value);
                const treatmentType = document.getElementById('treatmentType2').value;
                const treatmentPrice = parseFloat(document.getElementById('treatmentPrice2').value);
                const advancePayment = parseFloat(document.getElementById('advancePayment2').value);
                const remainingBalance = parseFloat(document.getElementById('remainingBalance2').value);
                
                addDebugInfo(`Agregando tratamiento al paciente ID: ${patientId}`);
                
                // Crear nuevo tratamiento
                const newTreatment = {
                    patient_id: patientId,
                    type: treatmentType,
                    price: treatmentPrice,
                    date: new Date().toISOString().split('T')[0]
                };
                
                // Agregar tratamiento a Supabase
                const treatmentId = await addTreatmentToAPI(newTreatment);
                
                // Crear nuevo pago
                const newPayment = {
                    treatment_id: treatmentId,
                    amount: advancePayment,
                    date: new Date().toISOString().split('T')[0],
                    status: remainingBalance > 0 ? "pending" : "paid"
                };
                
                // Agregar pago a Supabase
                await addPaymentToAPI(newPayment);
                
                // Recargar datos desde la API
                await loadDataFromAPI();
                
                // Cerrar modal
                closeAddTreatmentModal();
                
                // Mostrar notificación
                showNotification('Tratamiento agregado con éxito');
                
                // Actualizar detalles del paciente
                showPatientDetails(patientId);
                
                // Actualizar dashboard
                updateDashboard();
            } catch (error) {
                addDebugInfo(`Error al agregar tratamiento: ${error.message}`);
                showNotification('Error al agregar el tratamiento', 'error');
            }
        }
        
        // Manejar búsqueda
        async function handleSearch() {
            const query = document.getElementById('searchInput2').value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            // Limpiar resultados anteriores
            resultsContainer.innerHTML = '';
            
            if (query.length < 2) {
                return;
            }
            
            try {
                // Buscar pacientes en Supabase
                const filteredPatients = await searchPatientsOnAPI(query);
                
                // Mostrar resultados
                if (filteredPatients.length === 0) {
                    resultsContainer.innerHTML = '<p>No se encontraron pacientes que coincidan con la búsqueda.</p>';
                    return;
                }
                
                filteredPatients.forEach(patient => {
                    const patientItem = document.createElement('div');
                    patientItem.className = 'patient-item';
                    
                    const patientInfo = document.createElement('div');
                    patientInfo.className = 'patient-info';
                    patientInfo.innerHTML = `
                        <h3>${patient.full_name}</h3>
                        <p>Carnet: ${patient.id_number} | Teléfono: ${patient.phone}</p>
                    `;
                    
                    const patientActions = document.createElement('div');
                    patientActions.className = 'patient-actions';
                    
                    const viewDetailsBtn = document.createElement('button');
                    viewDetailsBtn.className = 'btn btn-primary btn-small';
                    viewDetailsBtn.innerHTML = '<i class="material-icons">visibility</i> Ver Detalles';
                    viewDetailsBtn.onclick = () => showPatientDetails(patient.id);
                    
                    patientActions.appendChild(viewDetailsBtn);
                    patientItem.appendChild(patientInfo);
                    patientItem.appendChild(patientActions);
                    resultsContainer.appendChild(patientItem);
                });
            } catch (error) {
                addDebugInfo(`Error al buscar pacientes: ${error.message}`);
                showNotification('Error al buscar pacientes', 'error');
            }
        }
        
        // Filtrar tabla de pacientes
        function filterPatientsTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const tableRows = document.querySelectorAll('#patientsTableBody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Mostrar detalles del paciente
        async function showPatientDetails(patientId) {
            try {
                addDebugInfo(`Mostrando detalles del paciente ID: ${patientId}`);
                
                // Obtener detalles del paciente desde Supabase
                const patientDetails = await getPatientDetailsFromAPI(patientId);
                
                if (!patientDetails) {
                    showNotification('Paciente no encontrado', 'error');
                    return;
                }
                
                const { patient, treatments, payments } = patientDetails;
                
                // Guardar el ID del paciente actual
                currentPatientId = patientId;
                
                // Calcular totales
                let totalPaid = 0;
                let totalPending = 0;
                
                (payments || []).forEach(payment => {
                    if (payment.status === 'paid') {
                        totalPaid += parseFloat(payment.amount);
                    } else {
                        totalPending += parseFloat(payment.amount);
                    }
                });
                
                // Construir contenido del modal
                let modalContent = `
                    <div class="patient-header">
                        <h2>${patient.full_name}</h2>
                        <p><strong>Carnet de Identidad:</strong> ${patient.id_number}</p>
                        <p><strong>Teléfono:</strong> ${patient.phone}</p>
                        <p><strong>Fecha de Registro:</strong> ${formatDate(patient.registration_date)}</p>
                    </div>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-accent" onclick="openAddTreatmentModal(${patient.id})">
                            <i class="material-icons">add</i>
                            Agregar Tratamiento
                        </button>
                    </div>
                    <div class="treatment-history">
                        <h3>Historial de Tratamientos</h3>
                        <table class="treatment-table">
                            <thead>
                                <tr>
                                    <th>Tratamiento</th>
                                    <th>Fecha</th>
                                    <th>Precio (Bs.)</th>
                                    <th>Adelanto (Bs.)</th>
                                    <th>Saldo (Bs.)</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                (treatments || []).forEach(treatment => {
                    const payment = (payments || []).find(p => p.treatment_id === treatment.id);
                    const status = payment ? payment.status : 'pending';
                    const statusClass = status === 'paid' ? 'status-paid' : (status === 'pending' ? 'status-pending' : 'status-overdue');
                    const statusText = status === 'paid' ? 'Pagado' : (status === 'pending' ? 'Pendiente' : 'Vencido');
                    
                    modalContent += `
                        <tr>
                            <td>${treatment.type}</td>
                            <td>${formatDate(treatment.date)}</td>
                            <td>Bs. ${treatment.price.toFixed(2)}</td>
                            <td>Bs. ${payment ? parseFloat(payment.amount).toFixed(2) : '0.00'}</td>
                            <td>Bs. ${(treatment.price - (payment ? parseFloat(payment.amount) : 0)).toFixed(2)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                modalContent += `
                            </tbody>
                        </table>
                    </div>
                    <div class="finance-summary" style="margin-top: 30px;">
                        <div class="finance-item">
                            <div class="finance-label">Total Pagado</div>
                            <div class="finance-value">Bs. ${totalPaid.toFixed(2)}</div>
                        </div>
                        <div class="finance-item">
                            <div class="finance-label">Saldo Pendiente</div>
                            <div class="finance-value">Bs. ${totalPending.toFixed(2)}</div>
                        </div>
                        <div class="finance-item">
                            <div class="finance-label">Total Tratamientos</div>
                            <div class="finance-value">${(treatments || []).length}</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                    </div>
                `;
                
                // Mostrar modal
                document.getElementById('modalBody').innerHTML = modalContent;
                document.getElementById('patientModal').style.display = 'flex';
            } catch (error) {
                addDebugInfo(`Error al cargar detalles del paciente: ${error.message}`);
                showNotification('Error al cargar los detalles del paciente', 'error');
            }
        }
        
        // Formatear fecha para mostrar
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Abrir modal para agregar tratamiento
        function openAddTreatmentModal(patientId) {
            document.getElementById('treatmentPatientId').value = patientId;
            document.getElementById('addTreatmentModal').style.display = 'flex';
        }
        
        // Cerrar modal para agregar tratamiento
        function closeAddTreatmentModal() {
            document.getElementById('addTreatmentModal').style.display = 'none';
            document.getElementById('treatmentForm').reset();
        }
        
        // Cerrar modal
        function closeModal() {
            document.getElementById('patientModal').style.display = 'none';
        }
        
        // Cerrar modal de cobros
        function closeRevenueModal() {
            document.getElementById('revenueModal').style.display = 'none';
        }
        
        // Actualizar dashboard
        async function updateDashboard() {
            try {
                addDebugInfo('Actualizando dashboard...');
                
                // Obtener estadísticas desde Supabase
                const stats = await getStatisticsFromAPI();
                
                // Actualizar contador de pacientes
                document.getElementById('patientsCount').textContent = stats.patientsCount;
                
                // Actualizar ingresos diarios
                document.getElementById('dailyRevenue').textContent = `Bs. ${stats.dailyRevenue.toFixed(2)}`;
                
                // Actualizar ingresos semanales
                document.getElementById('weeklyRevenue').textContent = `Bs. ${stats.weeklyRevenue.toFixed(2)}`;
                
                // Actualizar pacientes del día
                document.getElementById('todayPatients').textContent = stats.todayPatientsCount;
                
                addDebugInfo('Dashboard actualizado');
            } catch (error) {
                addDebugInfo(`Error al actualizar dashboard: ${error.message}`);
                showNotification('Error al cargar los datos del dashboard', 'error');
            }
        }
        
        // Llenar tabla de pacientes por día
        async function populateDailyPatientsTable() {
            try {
                const tableBody = document.getElementById('dailyPatientsTableBody');
                tableBody.innerHTML = '';
                
                // Obtener estadísticas desde Supabase
                const stats = await getStatisticsFromAPI();
                const dailyPatients = stats.dailyPatients || {};
                
                // Obtener los últimos 7 días
                const today = new Date();
                const dates = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                }
                
                // Contar pacientes por día
                dates.forEach(date => {
                    const patientCount = dailyPatients[date] || 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(date)}</td>
                        <td>${patientCount}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            } catch (error) {
                addDebugInfo(`Error al cargar pacientes por día: ${error.message}`);
                showNotification('Error al cargar la tabla de pacientes por día', 'error');
            }
        }
        
        // Mostrar tabla de pacientes
        function showPatientTable() {
            showSection('patients');
        }
        
        // Llenar tabla de pacientes
        function populatePatientsTable() {
            addDebugInfo(`Llenando tabla de pacientes. Total pacientes: ${patients.length}`);
            const tableBody = document.getElementById('patientsTableBody');
            tableBody.innerHTML = '';
            
            if (patients.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay pacientes registrados</td></tr>';
                return;
            }
            
            // Ordenar pacientes en orden descendente (último primero)
            const sortedPatients = [...patients];
            sortedPatients.sort((a, b) => b.id - a.id);
            
            sortedPatients.forEach(patient => {
                const row = document.createElement('tr');
                
                // Obtener tratamientos del paciente
                const patientTreatments = (treatments || []).filter(t => t.patient_id === patient.id);
                const treatmentIds = patientTreatments.map(t => t.id);
                const patientPayments = (payments || []).filter(p => treatmentIds.includes(p.treatment_id));
                
                // Obtener el tratamiento más reciente
                let latestTreatment = null;
                let treatmentStatus = 'Sin tratamiento';
                let statusClass = '';
                
                if (patientTreatments.length > 0) {
                    // Ordenar tratamientos por fecha (más reciente primero)
                    patientTreatments.sort((a, b) => new Date(b.date) - new Date(a.date));
                    latestTreatment = patientTreatments[0];
                    
                    // Buscar el pago para este tratamiento
                    const payment = patientPayments.find(p => p.treatment_id === latestTreatment.id);
                    
                    if (payment) {
                        if (payment.status === 'paid') {
                            treatmentStatus = `${latestTreatment.type} (Pagado)`;
                            statusClass = 'status-paid';
                        } else if (payment.status === 'pending') {
                            const balance = latestTreatment.price - parseFloat(payment.amount);
                            treatmentStatus = `${latestTreatment.type} (Pendiente: Bs. ${balance.toFixed(2)})`;
                            statusClass = 'status-pending';
                        } else {
                            treatmentStatus = `${latestTreatment.type} (Vencido)`;
                            statusClass = 'status-overdue';
                        }
                    } else {
                        treatmentStatus = `${latestTreatment.type} (Sin pago)`;
                        statusClass = 'status-overdue';
                    }
                }
                
                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.full_name}</td>
                    <td>${patient.id_number}</td>
                    <td>${patient.phone}</td>
                    <td>
                        ${patientTreatments.length > 0 ? 
                            `<span class="status-badge ${statusClass}">${treatmentStatus}</span>` : 
                            'Sin tratamiento'}
                    </td>
                    <td>${formatDate(patient.registration_date)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-small" onclick="showPatientDetails(${patient.id})">
                                <i class="material-icons">visibility</i> Ver
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            addDebugInfo(`Tabla de pacientes llenada con ${sortedPatients.length} registros`);
        }
        
        // Mostrar detalles de cobros diarios
        async function showDailyRevenue() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Obtener pagos del día desde Supabase
                const todayPayments = (payments || []).filter(p => p.date === today);
                
                // Construir contenido del modal
                let modalContent = `
                    <h3>Cobros del día (${formatDate(today)})</h3>
                    
                    <table class="revenue-table">
                        <thead>
                            <tr>
                                <th>ID Pago</th>
                                <th>ID Tratamiento</th>
                                <th>Monto (Bs.)</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                todayPayments.forEach(payment => {
                    const statusClass = payment.status === 'paid' ? 'status-paid' : (payment.status === 'pending' ? 'status-pending' : 'status-overdue');
                    const statusText = payment.status === 'paid' ? 'Pagado' : (payment.status === 'pending' ? 'Pendiente' : 'Vencido');
                    
                    modalContent += `

                        <tr>
                            <td>${payment.id}</td>
                            <td>${payment.treatment_id}</td>
                            <td>Bs. ${parseFloat(payment.amount).toFixed(2)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                modalContent += `
                        </tbody>
                    </table>
                    
                    
                    <div class="finance-summary" style="margin-top: 20px;">
                        <div class="finance-item">
                            <div class="finance-label">Total del Día</div>
                            <div class="finance-value">Bs. ${todayPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closeRevenueModal()">Cerrar</button>
                    </div>
                `;
                
                // Mostrar modal
                document.getElementById('revenueModalTitle').textContent = 'Cobros Diarios';
                document.getElementById('revenueModalBody').innerHTML = modalContent;
                document.getElementById('revenueModal').style.display = 'flex';
            } catch (error) {
                addDebugInfo(`Error al cargar cobros diarios: ${error.message}`);
                showNotification('Error al cargar los cobros diarios', 'error');
            }
        }
        
        // Mostrar detalles de cobros semanales
        async function showWeeklyRevenue() {
            try {
                // Obtener fecha de hace una semana
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                // Obtener pagos de la semana desde Supabase
                const weekPayments = (payments || []).filter(p => new Date(p.date) >= oneWeekAgo);
                
                // Construir contenido del modal
                let modalContent = `
                    <h3>Cobros de la última semana</h3>
                    
                    <table class="revenue-table">
                        <thead>
                            <tr>
                                <th>ID Pago</th>
                                <th>ID Tratamiento</th>
                                <th>Fecha</th>
                                <th>Monto (Bs.)</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                weekPayments.forEach(payment => {
                    const statusClass = payment.status === 'paid' ? 'status-paid' : (payment.status === 'pending' ? 'status-pending' : 'status-overdue');
                    const statusText = payment.status === 'paid' ? 'Pagado' : (payment.status === 'pending' ? 'Pendiente' : 'Vencido');
                    
                    modalContent += `
                        <tr>
                            <td>${payment.id}</td>
                            <td>${payment.treatment_id}</td>
                            <td>${formatDate(payment.date)}</td>
                            <td>Bs. ${parseFloat(payment.amount).toFixed(2)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                modalContent += `
                        </tbody>
                    </table>
                    
                    <div class="finance-summary" style="margin-top: 20px;">
                        <div class="finance-item">
                            <div class="finance-label">Total Semanal</div>
                            <div class="finance-value">Bs. ${weekPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closeRevenueModal()">Cerrar</button>
                    </div>
                `;
                
                // Mostrar modal
                document.getElementById('revenueModalTitle').textContent = 'Cobros Semanales';
                document.getElementById('revenueModalBody').innerHTML = modalContent;
                document.getElementById('revenueModal').style.display = 'flex';
            } catch (error) {
                addDebugInfo(`Error al cargar cobros semanales: ${error.message}`);
                showNotification('Error al cargar los cobros semanales', 'error');
            }
        }
        
        // Función para recargar manualmente los datos
        function reloadData() {
            addDebugInfo('Recargando datos manualmente...');
            showNotification('Recargando datos...', 'info');
            loadDataFromAPI().then((success) => {
                if (success) {
                    populatePatientsTable();
                    updateDashboard();
                    showNotification('Datos recargados correctamente');
                } else {
                    showNotification('No se pudieron recargar los datos', 'error');
                }
            }).catch(error => {
                addDebugInfo(`Error al recargar datos: ${error.message}`);
                showNotification('Error al recargar datos', 'error');
            });
        }
        
        // Mostrar notificación
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            // Cambiar color según el tipo
            if (type === 'error') {
                notification.style.backgroundColor = 'var(--danger-color)';
            } else if (type === 'info') {
                notification.style.backgroundColor = 'var(--secondary-color)';
            } else {
                notification.style.backgroundColor = 'var(--secondary-color)';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Inicialización cuando el DOM está cargado
        document.addEventListener('DOMContentLoaded', function() {
            addDebugInfo('DOM cargado, inicializando aplicación...');
            
            // Configurar eventos
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('patientForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('treatmentForm').addEventListener('submit', handleTreatmentSubmit);
            document.getElementById('searchInput2').addEventListener('input', handleSearch);
            document.getElementById('treatmentPrice').addEventListener('input', calculateBalance);
            document.getElementById('advancePayment').addEventListener('input', calculateBalance);
            document.getElementById('treatmentPrice2').addEventListener('input', calculateBalance2);
            document.getElementById('advancePayment2').addEventListener('input', calculateBalance2);
            
            // Agregar evento para mostrar/ocultar panel de depuración
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+D para mostrar/ocultar panel de depuración
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    toggleDebugPanel();
                }
            });
            
            // Verificar si hay un usuario guardado en localStorage
            const savedUser = loadSession();
            if (savedUser) {
                addDebugInfo('Usuario guardado encontrado');
                currentUser = savedUser;
                
                // Actualizar la interfaz
                document.getElementById('userAvatar').textContent = currentUser.avatar;
                document.getElementById('userName').textContent = currentUser.name;
                
                // Generar menú
                generateMenu();
                
                // Mostrar la aplicación principal
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Cargar datos desde la API ANTES de mostrar la sección
                loadDataFromAPI().then((success) => {
                    if (success) {
                        // Mostrar sección inicial (tabla de pacientes)
                        showSection('patients');
                        
                        // Actualizar dashboard
                        updateDashboard();
                    } else {
                        // Mostrar sección de todos modos
                        showSection('patients');
                        showNotification('No se pudieron cargar los datos. Intente recargar más tarde.', 'error');
                    }
                }).catch(error => {
                    addDebugInfo(`Error al cargar datos iniciales: ${error.message}`);
                    // Mostrar sección de todos modos
                    showSection('patients');
                    showNotification('Error al cargar datos. Intente recargar la página.', 'error');
                });
            } else {
                addDebugInfo('No hay usuario guardado, cargando datos desde API...');
                // Cargar datos desde la API
                loadDataFromAPI();
            }
        });
    </script>
</body>
</html>
